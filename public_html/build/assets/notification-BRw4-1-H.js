import{g as N,b as T,o as y,a as C}from"./index.esm2017-BXvIz_HN.js";function _(e){return new Date(e).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}function g(e){const t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,i=>t[i])}function M(){const e=document.getElementById("chat-messages");e.scrollTop=e.scrollHeight}function h(e){document.querySelectorAll("#chat-messages ul li").forEach(t=>{t.style.display=e?t.classList.contains("pinned")?"":"none":""})}function R(e,t,i,o,r,s){const a=document.getElementById("chat-messages");if(!a){console.error("Элемент chat-messages не найден!");return}const c=a.querySelector("ul");if(!c){console.error("Список сообщений не найден в chat-messages!");return}let d="",m=!1;e.forEach(n=>{if(!i.has(n.id)){if(m=!0,n.message_type==="notification"||n.is_system)d+=`
                    <li class="system-notification" data-id="${n.id}">
                        ${n.message}
                        <span class="message-time">${_(n.created_at)}</span>
                    </li>
                `;else{const u=n.sender_id===t,E=n.message_type==="notification"?"notification-message":u?"my-message":"other-message",L=n.is_pinned?"pinned":"";let $="";u&&n.is_read&&($='<span class="read-status">✓✓</span>');let f="";n.message&&n.message.trim()!==""&&(n.message_type==="notification"?f+=n.message:f+=`<div>${g(n.message)}</div>`),n.attachments&&Array.isArray(n.attachments)&&n.attachments.length>0&&n.attachments.forEach(l=>{l&&l.mime&&l.mime.startsWith("image/")?f+=`<div><img src="${l.url}" alt="Image" style="max-width:100%; border-radius:4px;"></div>`:l&&l.url&&(f+=`<div><a href="${l.url}" target="_blank">${g(l.original_file_name||"Файл")}</a></div>`)}),f.trim()===""&&(f='<div style="color:#888;">[Пустое сообщение]</div>');let b="";u&&(b=`
                        <div class="message-controls">
                            <button class="delete-message" data-id="${n.id}"><img src="${deleteImgUrl}" alt="Удалить"></button>
                            ${n.is_pinned?`<button class="unpin-message" data-id="${n.id}"><img src="${unpinImgUrl}" alt="Открепить"></button>`:`<button class="pin-message" data-id="${n.id}"><img src="${pinImgUrl}" alt="Закрепить"></button>`}
                        </div>
                    `),d+=`
                    <li class="${E} ${L}" data-id="${n.id}">
                        <div><strong>${u?"Вы":g(n.sender_name||"Неизвестно")}</strong></div>
                        ${f}
                        ${b}
                        <span class="message-time">${_(n.created_at)}</span>
                        ${$}
                    </li>
                `}i.add(n.id)}}),d&&m&&(c.insertAdjacentHTML("beforeend",d),M(),A(o,r,s),h())}function A(e,t,i){document.querySelectorAll(".delete-message").forEach(o=>{o.onclick=function(){const r=this.getAttribute("data-id");confirm("Удалить сообщение?")&&fetch(`/chats/${t}/${i}/messages/${r}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":e,"Content-Type":"application/json"}}).then(s=>s.json()).then(s=>{s.success?this.closest("li").remove():alert(s.error||"Ошибка удаления сообщения")}).catch(s=>console.error("Ошибка:",s))}}),document.querySelectorAll(".pin-message").forEach(o=>{o.onclick=function(){const r=this.getAttribute("data-id");fetch(`/chats/${t}/${i}/messages/${r}/pin`,{method:"POST",headers:{"X-CSRF-TOKEN":e,"Content-Type":"application/json"}}).then(s=>s.json()).then(s=>{if(s.success){this.innerHTML=`<img src="${unpinImgUrl}" alt="Открепить">`,this.classList.remove("pin-message"),this.classList.add("unpin-message");let a=this.closest("li");if(a.classList.add("pinned"),a&&!a.querySelector(".pinned-label")){let c=document.createElement("span");c.classList.add("pinned-label"),c.textContent=" [Закреплено]",a.querySelector("div").appendChild(c)}h()}else console.error("Ошибка закрепления сообщения:",s.error),alert(s.error||"Ошибка закрепления сообщения")}).catch(s=>{console.error("Ошибка при закреплении сообщения:",s)})}}),document.querySelectorAll(".unpin-message").forEach(o=>{o.onclick=function(){const r=this.getAttribute("data-id");fetch(`/chats/${t}/${i}/messages/${r}/unpin`,{method:"POST",headers:{"X-CSRF-TOKEN":e,"Content-Type":"application/json"}}).then(s=>s.json()).then(s=>{if(s.success){this.innerHTML=`<img src="${pinImgUrl}" alt="Закрепить">`,this.classList.remove("unpin-message"),this.classList.add("pin-message");let a=this.closest("li");a.classList.remove("pinned");let c=a.querySelector(".pinned-label");c&&c.remove(),h()}else alert(s.error||"Ошибка открепления сообщения")}).catch(s=>console.error("Ошибка:",s))}})}const p=N(T);var v;const S=(v=document.querySelector('meta[name="user-id"]'))==null?void 0:v.getAttribute("content");document.addEventListener("DOMContentLoaded",()=>{Notification.permission!=="granted"&&Notification.permission!=="denied"?Notification.requestPermission().then(e=>{e==="granted"&&w()}):Notification.permission==="granted"&&w(),window.firebaseNotifHandlerRegistered||(y(p,e=>{var c,d,m,n;if(console.log("Получено push‑уведомление:",e),e.data&&e.data.recipient_id&&e.data.recipient_id!==S)return;const t=((c=e.data)==null?void 0:c.sender_name)||"Неизвестно",i=((d=e.data)==null?void 0:d.message_text)||((m=e.notification)==null?void 0:m.body)||"",o=`Новое сообщение от: ${t}`,s={body:`Сообщение: ${i}`,icon:((n=e.notification)==null?void 0:n.icon)||"/firebase-logo.png",tag:`global-notif-${Date.now()}`};let a=new Notification(o,s);a.onclick=function(u){u.preventDefault(),window.focus()},new Audio("/firebase-sound.mp3").play()}),window.firebaseNotifHandlerRegistered=!0),I()});function w(){C(p,{vapidKey:"BLf08mEO3lePyBvZCwTzaSNX9R981qwESUblCemdDVZUT_cs4G3GD2YY38CN8ELIcPmgVRZ92G7ePzY187d4Dh4"}).then(e=>{e?(console.log("Получен FCM токен:",e.substring(0,20)+"..."),fetch("/firebase/update-token",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({token:e})}).then(t=>{t.ok?console.log("Токен успешно сохранён на сервере"):console.error("Ошибка при сохранении токена на сервере")}).catch(t=>console.error("Ошибка отправки токена:",t))):console.error("Не удалось получить токен FCM")}).catch(e=>console.error("Ошибка получения токена FCM:",e))}function q(e,t,i={}){i.sender_name&&i.message_text&&(e=`Новое сообщение от: ${i.sender_name}`,t=`Сообщение: ${i.message_text}`),console.log("Уведомление:",e,t);let o=new Notification(e,{body:t,icon:"/firebase-logo.png",data:i});o.onclick=function(r){r.preventDefault(),window.focus()},new Audio("/firebase-sound.mp3").play()}function U(){window.firebaseNotifHandlerRegistered||(y(p,e=>{var o,r,s,a;if(e.data&&e.data.recipient_id&&e.data.recipient_id!==S)return;const t=(o=e.data)!=null&&o.sender_name?`Новое сообщение от ${e.data.sender_name}`:((r=e.notification)==null?void 0:r.title)||"Новое уведомление",i=(s=e.data)!=null&&s.message_text?`Сообщение: ${e.data.message_text}`:((a=e.notification)==null?void 0:a.body)||"";q(t,i,e.data)}),window.firebaseNotifHandlerRegistered=!0)}function I(){let e=0;setInterval(()=>{fetch("/chats/unread-counts").then(t=>t.json()).then(t=>{if(t.unread_counts&&t.unread_counts.length>0){const i=t.unread_counts.reduce((o,r)=>o+parseInt(r.unread_count||0),0);if(i>e){const o="Новые сообщения",r=`У вас появилось ${i-e} новых сообщений.`;new Notification(o,{body:r,icon:"/firebase-logo.png"})}e=i}else e=0}).catch(t=>console.error("Ошибка при получении непрочитанных сообщений:",t))},1e4)}export{_ as a,U as c,h as f,R as r};
