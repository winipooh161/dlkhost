import{g as b,o as h,a as p,b as w}from"./index.esm2017-BXvIz_HN.js";const u=b(w);var f;const N=(f=document.querySelector('meta[name="user-id"]'))==null?void 0:f.getAttribute("content");document.addEventListener("DOMContentLoaded",()=>{Notification.permission!=="granted"&&Notification.permission!=="denied"?Notification.requestPermission().then(e=>{e==="granted"&&d()}):Notification.permission==="granted"&&d(),window.firebaseNotifHandlerRegistered||(h(u,e=>{var s,r,c,a;if(console.log("Получено push‑уведомление:",e),e.data&&e.data.recipient_id&&e.data.recipient_id!==N)return;const n=((s=e.data)==null?void 0:s.sender_name)||"Неизвестно",t=((r=e.data)==null?void 0:r.message_text)||((c=e.notification)==null?void 0:c.body)||"",o=`Новое сообщение от: ${n}`,l={body:`Сообщение: ${t}`,icon:((a=e.notification)==null?void 0:a.icon)||"/firebase-logo.png",tag:`global-notif-${Date.now()}`};let g=new Notification(o,l);g.onclick=function(m){m.preventDefault(),window.focus()},new Audio("/firebase-sound.mp3").play()}),window.firebaseNotifHandlerRegistered=!0),C()});function d(){p(u,{vapidKey:"BLf08mEO3lePyBvZCwTzaSNX9R981qwESUblCemdDVZUT_cs4G3GD2YY38CN8ELIcPmgVRZ92G7ePzY187d4Dh4"}).then(e=>{e?(console.log("Получен FCM токен:",e.substring(0,20)+"..."),fetch("/firebase/update-token",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({token:e})}).then(n=>{n.ok?console.log("Токен успешно сохранён на сервере"):console.error("Ошибка при сохранении токена на сервере")}).catch(n=>console.error("Ошибка отправки токена:",n))):console.error("Не удалось получить токен FCM")}).catch(e=>console.error("Ошибка получения токена FCM:",e))}function C(){let e=0;setInterval(()=>{fetch("/chats/unread-counts").then(n=>n.json()).then(n=>{if(n.unread_counts&&n.unread_counts.length>0){const t=n.unread_counts.reduce((o,i)=>o+parseInt(i.unread_count||0),0);if(t>e){const o="Новые сообщения",i=`У вас появилось ${t-e} новых сообщений.`;new Notification(o,{body:i,icon:"/firebase-logo.png"})}e=t}else e=0}).catch(n=>console.error("Ошибка при получении непрочитанных сообщений:",n))},1e4)}
