import{i as M,g as v,a as E,o as L}from"./index.esm2017-NZQW5Whv.js";function T(t,i,n){document.querySelectorAll(".delete-message").forEach(l=>{l.onclick=function(){const r=this.getAttribute("data-id");confirm("Удалить сообщение?")&&fetch(`/chats/${i}/${n}/messages/${r}`,{method:"DELETE",headers:{"X-CSRF-TOKEN":t,"Content-Type":"application/json"}}).then(s=>s.json()).then(s=>{s.success?this.closest("li").remove():alert(s.error||"Ошибка удаления сообщения")}).catch(s=>console.error("Ошибка:",s))}}),document.querySelectorAll(".pin-message").forEach(l=>{l.onclick=function(){const r=this.getAttribute("data-id");fetch(`/chats/${i}/${n}/messages/${r}/pin`,{method:"POST",headers:{"X-CSRF-TOKEN":t,"Content-Type":"application/json"}}).then(s=>s.json()).then(s=>{if(s.success){this.innerHTML=`<img src="${unpinImgUrl}" alt="Открепить">`,this.classList.remove("pin-message"),this.classList.add("unpin-message");let o=this.closest("li");if(o.classList.add("pinned"),o&&!o.querySelector(".pinned-label")){let a=document.createElement("span");a.classList.add("pinned-label"),a.textContent=" [Закреплено]",o.querySelector("div").appendChild(a)}filterMessages()}else console.error("Ошибка закрепления сообщения:",s.error),alert(s.error||"Ошибка закрепления сообщения")}).catch(s=>{console.error("Ошибка при закреплении сообщения:",s)})}}),document.querySelectorAll(".unpin-message").forEach(l=>{l.onclick=function(){const r=this.getAttribute("data-id");fetch(`/chats/${i}/${n}/messages/${r}/unpin`,{method:"POST",headers:{"X-CSRF-TOKEN":t,"Content-Type":"application/json"}}).then(s=>s.json()).then(s=>{if(s.success){this.innerHTML=`<img src="${pinImgUrl}" alt="Закрепить">`,this.classList.remove("unpin-message"),this.classList.add("pin-message");let o=this.closest("li");o.classList.remove("pinned");let a=o.querySelector(".pinned-label");a&&a.remove(),filterMessages()}else alert(s.error||"Ошибка открепления сообщения")}).catch(s=>console.error("Ошибка:",s))}})}function $(t){return new Date(t).toLocaleTimeString("ru-RU",{hour:"2-digit",minute:"2-digit"})}function g(t){const i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,n=>i[n])}function C(){const t=document.getElementById("chat-messages");t.scrollTop=t.scrollHeight}function A(t){document.querySelectorAll("#chat-messages ul li").forEach(i=>{i.style.display=t?i.classList.contains("pinned")?"":"none":""})}function N(t,i,n,l,r,s){const o=document.getElementById("chat-messages");if(!o){console.error("Элемент chat-messages не найден!");return}const a=o.querySelector("ul");if(!a){console.error("Список сообщений не найден в chat-messages!");return}let m="",p=!1;t.forEach(e=>{if(!n.has(e.id)){if(p=!0,e.message_type==="notification"||e.is_system)m+=`
                    <li class="system-notification" data-id="${e.id}">
                        ${e.message}
                        <span class="message-time">${$(e.created_at)}</span>
                    </li>
                `;else{const f=e.sender_id===i,b=e.message_type==="notification"?"notification-message":f?"my-message":"other-message",S=e.is_pinned?"pinned":"";let u="";f&&e.is_read&&(u='<span class="read-status">✓✓</span>');let d="";e.message&&e.message.trim()!==""&&(e.message_type==="notification"?d+=e.message:d+=`<div>${g(e.message)}</div>`),e.attachments&&Array.isArray(e.attachments)&&e.attachments.length>0&&e.attachments.forEach(c=>{c&&c.mime&&c.mime.startsWith("image/")?d+=`<div><img src="${c.url}" alt="Image" style="max-width:100%; border-radius:4px;"></div>`:c&&c.url&&(d+=`<div><a href="${c.url}" target="_blank">${g(c.original_file_name||"Файл")}</a></div>`)}),d.trim()===""&&(d='<div style="color:#888;">[Пустое сообщение]</div>');let h="";f&&(h=`
                        <div class="message-controls">
                            <button class="delete-message" data-id="${e.id}"><img src="${deleteImgUrl}" alt="Удалить"></button>
                            ${e.is_pinned?`<button class="unpin-message" data-id="${e.id}"><img src="${unpinImgUrl}" alt="Открепить"></button>`:`<button class="pin-message" data-id="${e.id}"><img src="${pinImgUrl}" alt="Закрепить"></button>`}
                        </div>
                    `),m+=`
                    <li class="${b} ${S}" data-id="${e.id}">
                        <div><strong>${f?"Вы":g(e.sender_name||"Неизвестно")}</strong></div>
                        ${d}
                        ${h}
                        <span class="message-time">${$(e.created_at)}</span>
                        ${u}
                    </li>
                `}n.add(e.id)}}),m&&p&&(a.insertAdjacentHTML("beforeend",m),C(),T(l,r,s),A())}const _={apiKey:"AIzaSyB6N1n8dW95YGMMuTsZMRnJY1En7lK2s2M",authDomain:"dlk-diz.firebaseapp.com",projectId:"dlk-diz",storageBucket:"dlk-diz.firebasestorage.app",messagingSenderId:"209164982906",appId:"1:209164982906:web:0836fbb02e7effd80679c3"},I=M(_),y=v(I);Notification.requestPermission().then(t=>{t==="granted"?E(y,{vapidKey:"BLf08mEO3lePyBvZCwTzaSNX9R981qwESUblCemdDVZUT_cs4G3GD2YY38CN8ELIcPmgVRZ92G7ePzY187d4Dh4"}).then(i=>{i?(console.log("FCM Token:",i),fetch("/firebase/update-token",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').getAttribute("content")},body:JSON.stringify({token:i})})):console.warn("Не удалось получить токен.")}).catch(i=>{console.error("Ошибка получения токена:",i)}):console.warn("Разрешение на уведомления не предоставлено.")});function q(t,i,n={}){console.log("Уведомление:",t,i),new Notification(t,{body:i,icon:"/firebase-logo.png",data:n})}function k(){L(y,t=>{console.log("Message received. ",t),q(t.notification.title,t.notification.body,t.data)})}export{A as a,k as c,$ as f,N as r};
